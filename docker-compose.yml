version: "3.9"

services:
  # Base de données Postgres (service authentification)
  db_postgres_auth:
    image: postgres
    container_name: bdd_auth
#    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: bdd_auth
    ports:
      - "5432:5432"


  # Base de données Postgres (service notification)
  db_postgres_notif:
    image: postgres
    container_name: bdd_notif
#    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: bdd_notif
    ports:
      - "5433:5432"

#  # Base de données MongoDB (service gestion des rendez-vous des patients)
#  db_mongo1:

#  # Base de données MongoDB (service gestion des stocks et commandes)
#  db_mongo2:

 # Base de données (service facturation)


  # Service annuaire
  discovery:
    image: consul:1.11
    ports:
      - "8500:8500"
    networks:
      - consul

  # Service de messagerie
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    hostname: rabbit-messaging
    ports:
      - "5672:5672"
      - "15672:15672"
#    restart: always

  # Service de notification
  service-notif:
    build: ./service-notification
#    restart: always
    environment:
      - JAVA_TOOL_OPTIONS=
        -DCONSUL_HOST=discovery -DCONSUL_PORT=8500
    depends_on:
      - discovery
      - db_postgres_notif
      - service-auth
    networks:
      - consul

  # Service d'authentification
  service-auth:
    build: ./service-authentification
    restart: always
    environment:
      - JAVA_TOOL_OPTIONS=
        -DCONSUL_HOST=discovery -DCONSUL_PORT=8500
    depends_on:
      - discovery
      - db_postgres_auth
    networks:
      - consul


  # Service gateway (proxy)
#  gateway:
#    build: ./gateway
#    restart: always
#    ports:
#      - "8080:8080"
#    environment:
#      - JAVA_TOOL_OPTIONS=
#        -DCONSUL_HOST=discovery -DCONSUL_PORT=8500
#    depends_on:
#      - discovery
#    networks:
#      - consul

networks:
  consul:
    driver: bridge